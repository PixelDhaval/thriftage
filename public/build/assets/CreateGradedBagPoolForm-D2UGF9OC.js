import{r as g,j as e,a as y}from"./app-CMik14HJ.js";import{A as Y}from"./async-select-DZWKgv0B.js";import{B as $,t as o}from"./index-CakOBAWj.js";import{I as J}from"./input-ALDPQvLe.js";import{L as v}from"./label-DRAuss-2.js";import{S as I,a as T,b as G,c as R,d as U}from"./select-BvBzlWgt.js";import{D as Z,a as ee,b as te,c as ae,d as se}from"./dialog-HoTurtI_.js";import{P as ie}from"./progress-CcY1VPtl.js";import{p as V}from"./printGradedBarcodes-hWLuY7XN.js";import{C as re}from"./circle-alert-BEy3JBDd.js";import{P as L}from"./printer-BuOk2LrS.js";import"./floating-ui.dom-C5vApqfE.js";import"./floating-ui.react-dom-CUGvTVI4.js";import"./index-BBZuHhmn.js";import"./check-DU87odb6.js";import"./index-Cmy6J4pR.js";function Ne({isOpen:N,onClose:F,onSuccess:f}){const[D,A]=g.useState(!1),[a,_]=g.useState({item_id:"",grade_id:"",weight_id:"",quantity:1}),[r,S]=g.useState(null),[P,Q]=g.useState([]),[b,O]=g.useState([]),[ne,q]=g.useState(0),[n,k]=g.useState(null),[c,j]=g.useState({current:0,total:0,isProcessing:!1,isPrinting:!1,currentBatch:[]});g.useEffect(()=>{N&&(async()=>{try{const[s,i]=await Promise.all([y.get("/api/grades"),y.get("/api/weights")]);Q(s.data),O(i.data)}catch(s){console.error("Error fetching data:",s),o.error("Failed to load form data.")}})()},[N]),g.useEffect(()=>{(async()=>{if(a.item_id&&a.grade_id&&a.weight_id&&a.quantity)try{const s=b.find(u=>u.id.toString()===a.weight_id),i=a.quantity*parseFloat((s==null?void 0:s.weight)||"0"),m=await y.post("/api/graded-stock/check-availability",{item_id:a.item_id,grade_id:a.grade_id,required_weight:i});k(m.data),q(m.data.available_weight)}catch(s){console.error("Error checking stock:",s),k(null),q(0)}else k(null),q(0)})()},[a.item_id,a.grade_id,a.weight_id,a.quantity,b]);const z=t=>{S(t),_(s=>({...s,item_id:(t==null?void 0:t.id)||""}))},B=(t,s)=>{_(i=>({...i,[t]:s}))},K=async t=>{var i;return(await y.post("/api/graded-bags-pools/batch",t,{headers:{"X-CSRF-TOKEN":((i=document.querySelector('meta[name="csrf-token"]'))==null?void 0:i.getAttribute("content"))||"","Content-Type":"application/json",Accept:"application/json"}})).data},M=async()=>{var m,u,p;const t=a.quantity,s=10,i=Math.ceil(t/s);j({current:0,total:i,isProcessing:!0,isPrinting:!1,currentBatch:[]});try{const l=b.find(d=>d.id.toString()===a.weight_id),x=P.find(d=>d.id.toString()===a.grade_id);for(let d=0;d<i;d++){const h=Math.min(s,t-d*s);j(w=>({...w,current:d+1,isProcessing:!0,isPrinting:!1}));const W={item_id:a.item_id,grade_id:a.grade_id,weight_id:a.weight_id,quantity:h},E=(await K(W)).graded_bags_pools;j(w=>({...w,currentBatch:E,isProcessing:!1,isPrinting:!0})),await V({bags:E,partyName:"Graded Items",weightValue:(l==null?void 0:l.weight)||"Unknown",itemName:(r==null?void 0:r.name)||"Unknown",itemSection:(m=r==null?void 0:r.section)==null?void 0:m.name,gradeName:(x==null?void 0:x.name)||"Unknown"}),o.success(`Batch ${d+1}/${i} completed: ${h} graded bags created and printed.`),d<i-1&&await new Promise(w=>setTimeout(w,200))}j({current:0,total:0,isProcessing:!1,isPrinting:!1,currentBatch:[]}),o.success(`All ${t} graded bags created and printed successfully!`),_({item_id:"",grade_id:"",weight_id:"",quantity:1}),S(null),f==null||f()}catch(l){console.error("Error in batch processing:",l),(p=(u=l.response)==null?void 0:u.data)!=null&&p.message?o.error(l.response.data.message):o.error("Failed to process batches. Please try again later."),j({current:0,total:0,isProcessing:!1,isPrinting:!1,currentBatch:[]})}},X=async t=>{var s,i,m,u;if(t.preventDefault(),!a.item_id||!a.grade_id||!a.weight_id||!a.quantity){o.error("Please fill in all required fields");return}if(a.quantity<1||a.quantity>100){o.error("Quantity must be between 1 and 100");return}if(n&&!n.is_sufficient){o.error(`Insufficient stock. Available: ${n.available_weight}kg, Required: ${n.required_weight}kg`);return}if(A(!0),a.quantity<=10)try{const l=(await y.post("/graded-bags-pools",a,{headers:{"X-CSRF-TOKEN":((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.getAttribute("content"))||"","Content-Type":"application/json",Accept:"application/json"}})).data.graded_bags_pools||[];if(o.success(`${a.quantity} graded bags created successfully!`),l.length>0&&r){const x=b.find(h=>h.id.toString()===a.weight_id),d=P.find(h=>h.id.toString()===a.grade_id);try{await V({bags:l,partyName:"Graded Items",weightValue:(x==null?void 0:x.weight)||"Unknown",itemName:(r==null?void 0:r.name)||"Unknown",itemSection:(i=r==null?void 0:r.section)==null?void 0:i.name,gradeName:(d==null?void 0:d.name)||"Unknown"}),o.success("Labels printed successfully!")}catch(h){console.error("Print error:",h),o.error("Graded bags created but printing failed. You can print them later.")}}_({item_id:"",grade_id:"",weight_id:"",quantity:1}),S(null),f==null||f()}catch(p){console.error("Error creating graded bags:",p),(u=(m=p.response)==null?void 0:m.data)!=null&&u.message?o.error(p.response.data.message):o.error("Failed to create graded bags. Please try again later.")}else await M();A(!1)},C=c.isProcessing||c.isPrinting,H=c.total>0?c.current/c.total*100:0;return e.jsx(Z,{open:N,onOpenChange:F,children:e.jsxs(ee,{className:"max-w-md",children:[e.jsxs(te,{children:[e.jsx(ae,{children:"Create Graded Bag Pool"}),e.jsx(se,{children:"Create new graded bags. Press Ctrl+O to open this dialog."})]}),e.jsxs("form",{onSubmit:X,className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(v,{htmlFor:"item",children:"Item *"}),e.jsx(Y,{route:"/api/items/select",value:r,onChange:z,placeholder:"Select item",renderOption:t=>{var s;return`${t.name} - ${((s=t.section)==null?void 0:s.name)||"No Section"}`},renderSelected:t=>t.name})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(v,{htmlFor:"grade",children:"Grade *"}),e.jsxs(I,{value:a.grade_id,onValueChange:t=>B("grade_id",t),required:!0,children:[e.jsx(T,{children:e.jsx(G,{placeholder:"Select grade"})}),e.jsx(R,{children:P.map(t=>e.jsx(U,{value:t.id.toString(),children:t.name},t.id))})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(v,{htmlFor:"weight",children:"Weight *"}),e.jsxs(I,{value:a.weight_id,onValueChange:t=>B("weight_id",t),required:!0,children:[e.jsx(T,{children:e.jsx(G,{placeholder:"Select weight"})}),e.jsx(R,{children:b.map(t=>e.jsxs(U,{value:t.id.toString(),children:[t.weight," kg"]},t.id))})]})]}),n&&e.jsx("div",{className:`p-3 border rounded-lg ${n.is_sufficient?"bg-green-50 border-green-200":"bg-red-50 border-red-200"}`,children:e.jsxs("div",{className:`text-sm ${n.is_sufficient?"text-green-900":"text-red-900"}`,children:[e.jsx("div",{className:"font-medium mb-1",children:"Stock Availability:"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{children:["Available: ",e.jsxs("span",{className:"font-bold",children:[n.available_weight," kg"]})]}),e.jsxs("div",{children:["Required: ",e.jsxs("span",{className:"font-bold",children:[n.required_weight," kg"]})]}),!n.is_sufficient&&e.jsxs("div",{className:"text-red-700",children:["Shortage: ",e.jsxs("span",{className:"font-bold",children:[n.shortage," kg"]})]})]}),n.is_sufficient?e.jsx("div",{className:"mt-2 text-green-700 font-medium",children:"‚úì Sufficient stock available"}):e.jsx("div",{className:"mt-2 text-red-700 font-medium",children:"‚úó Insufficient stock"})]})}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(v,{htmlFor:"quantity",children:"Quantity *"}),e.jsx(J,{id:"quantity",type:"number",min:"1",max:"100",value:a.quantity,onChange:t=>B("quantity",parseInt(t.target.value)),placeholder:"Enter quantity (1-100)",required:!0}),a.weight_id&&e.jsx("div",{className:"text-sm text-muted-foreground",children:(()=>{const t=b.find(i=>i.id.toString()===a.weight_id);return`Total weight required: ${a.quantity*parseFloat((t==null?void 0:t.weight)||"0")}kg`})()}),a.quantity>10&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-amber-600",children:[e.jsx(re,{className:"h-4 w-4"}),e.jsx("span",{children:"Quantities over 10 will be processed in batches of 10 with automatic printing."})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Graded bags will be created with automatic barcode printing."})]}),C&&e.jsxs("div",{className:"border rounded-lg p-4 bg-blue-50",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(L,{className:"h-4 w-4 text-blue-600"}),e.jsxs("span",{className:"font-medium text-blue-900",children:[c.isPrinting?"Printing Batch":"Creating Batch"," ",c.current," of ",c.total]})]}),e.jsx(ie,{value:H,className:"mb-2"}),e.jsx("div",{className:"text-sm text-blue-700",children:c.isPrinting?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-pulse",children:"üñ®Ô∏è"}),e.jsxs("span",{children:["Printing ",c.currentBatch.length," graded barcodes... Please ensure printer is ready."]})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin",children:"‚è≥"}),e.jsx("span",{children:"Creating graded bags..."})]})}),c.currentBatch.length>0&&e.jsxs("div",{className:"mt-3 p-2 bg-white rounded border",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Current Batch Barcodes:"}),e.jsxs("div",{className:"flex flex-wrap gap-1",children:[c.currentBatch.slice(0,5).map(t=>e.jsx("span",{className:"text-xs font-mono bg-gray-100 px-1 rounded",children:t.barcode},t.id)),c.currentBatch.length>5&&e.jsxs("span",{className:"text-xs text-gray-500",children:["+",c.currentBatch.length-5," more"]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx($,{variant:"outline",type:"button",onClick:F,children:"Cancel"}),e.jsx($,{type:"submit",disabled:D||C||n&&!n.is_sufficient,className:"gap-2",children:C?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin",children:"‚è≥"}),"Processing..."]}):D?"Creating...":e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"h-4 w-4"}),"Create & Print Labels"]})})]})]})]})})}export{Ne as default};
