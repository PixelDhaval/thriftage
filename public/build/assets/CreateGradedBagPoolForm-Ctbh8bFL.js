import{j as e,r as p,a as S}from"./app-B81GrNVN.js";import{A as ne}from"./async-select-DsxhFxiQ.js";import{a as oe,S as de,c as le,d as ce,B as W,t as o}from"./index-BmlTZoYn.js";import{D as ge,a as he,b as ue,c as pe,d as me}from"./dialog-_1aMC81m.js";import{I as L}from"./input-CgHuFDRy.js";import{L as k}from"./label-abHCevWa.js";import{C as fe,P as xe}from"./progress-Cv1I-sH5.js";import{S as M,a as O,b as z,c as Q,d as K}from"./select-BUwKcd6J.js";import{p as X}from"./printGradedBarcodes-C9_5HlU_.js";import{P as H}from"./printer-CUg1IuD4.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],we=oe("Info",be),ve=ce("inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-auto",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",secondary:"border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",destructive:"border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40",outline:"text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",success:"border-transparent bg-green-500 text-white [a&]:hover:bg-green-600",warning:"border-transparent bg-yellow-500 text-white [a&]:hover:bg-yellow-600",info:"border-transparent bg-blue-500 text-white [a&]:hover:bg-blue-600",pending:"border-transparent bg-orange-400 text-white [a&]:hover:bg-orange-500",amber:"border-transparent bg-amber-500 text-white [a&]:hover:bg-amber-600",purple:"border-transparent bg-purple-500 text-white [a&]:hover:bg-purple-600",pink:"border-transparent bg-pink-500 text-white [a&]:hover:bg-pink-600",teal:"border-transparent bg-teal-500 text-white [a&]:hover:bg-teal-600",indigo:"border-transparent bg-indigo-500 text-white [a&]:hover:bg-indigo-600"}},defaultVariants:{variant:"default"}});function Y({className:y,variant:P,asChild:f=!1,...q}){const C=f?de:"span";return e.jsx(C,{"data-slot":"badge",className:le(ve({variant:P}),y),...q})}function _e({isOpen:y,onClose:P,onSuccess:f}){var R;const[q,C]=p.useState(!1),[a,w]=p.useState({item_id:"",grade_id:"",weight_id:"",quantity:1,weight_value:0}),[r,B]=p.useState(null),[T,J]=p.useState([]),[x,U]=p.useState([]),[je,E]=p.useState(0),[g,D]=p.useState(null),[h,A]=p.useState(!1),[I,$]=p.useState("kg"),[d,N]=p.useState({current:0,total:0,isProcessing:!1,isPrinting:!1,currentBatch:[]});p.useEffect(()=>{y&&((async()=>{try{const i=await S.get("/api/grades");J(i.data)}catch(i){console.error("Error fetching grades:",i),o.error("Failed to load grades.")}})(),w({item_id:"",grade_id:"",weight_id:"",quantity:1,weight_value:0}),B(null),$("kg"),A(!1))},[y]),p.useEffect(()=>{var t;if(r){if(r.grade_id&&w(i=>({...i,grade_id:r.grade_id.toString()})),(t=r.section)!=null&&t.weight_type){const i=r.section.weight_type;$(i),A(i==="pair");const s=r.default_weight_id;(async()=>{try{const l=await S.get("/api/weights",{params:{weight_type:i}});U(l.data),s&&setTimeout(()=>{w(c=>({...c,weight_id:s.toString()}))},100),console.log(s)}catch(l){console.error("Error fetching weights for section:",l),o.error("Failed to load weights for this section.")}})()}}else U([]),$("kg"),A(!1)},[r]),p.useEffect(()=>{(async()=>{if(a.item_id&&a.grade_id&&a.weight_id)try{let i;if(h)i=a.weight_value;else{const u=x.find(l=>l.id.toString()===a.weight_id);i=a.quantity*parseFloat((u==null?void 0:u.weight)||"0")}const s=await S.post("/api/graded-stock/check-availability",{item_id:a.item_id,grade_id:a.grade_id,required_weight:i,include_pair_info:h});D(s.data),E(s.data.available_weight)}catch(i){console.error("Error checking stock:",i),D(null),E(0)}else D(null),E(0)})()},[a.item_id,a.grade_id,a.weight_id,a.quantity,a.weight_value,x,h]);const Z=t=>{B(t),w(i=>({...i,item_id:(t==null?void 0:t.id)||"",weight_id:(t==null?void 0:t.default_weight_id)||""}))},F=(t,i)=>{w(s=>({...s,[t]:i}))},ee=async t=>{var s;return(await S.post("/api/graded-bags-pools/batch",t,{headers:{"X-CSRF-TOKEN":((s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.getAttribute("content"))||"","Content-Type":"application/json",Accept:"application/json"}})).data},te=async()=>{var u,l,c;const t=a.quantity,i=10,s=Math.ceil(t/i);N({current:0,total:s,isProcessing:!0,isPrinting:!1,currentBatch:[]});try{const m=x.find(n=>n.id.toString()===a.weight_id),j=T.find(n=>n.id.toString()===a.grade_id);for(let n=0;n<s;n++){const v=Math.min(i,t-n*i);N(_=>({..._,current:n+1,isProcessing:!0,isPrinting:!1}));let b={item_id:a.item_id,grade_id:a.grade_id,weight_id:a.weight_id,quantity:v};if(h){const _=a.weight_value/t*v;b.weight=_}const V=(await ee(b)).graded_bags_pools;N(_=>({..._,currentBatch:V,isProcessing:!1,isPrinting:!0})),await X({bags:V,partyName:"Graded Items",weightValue:(m==null?void 0:m.weight)||"Unknown",itemName:(r==null?void 0:r.name)||"Unknown",itemSection:(u=r==null?void 0:r.section)==null?void 0:u.name,gradeName:(j==null?void 0:j.name)||"Unknown",weightType:I,pairCount:h?parseInt(m==null?void 0:m.weight):void 0}),o.success(`Batch ${n+1}/${s} completed: ${v} graded bags created and printed.`),n<s-1&&await new Promise(_=>setTimeout(_,200))}N({current:0,total:0,isProcessing:!1,isPrinting:!1,currentBatch:[]}),o.success(`All ${t} graded bags created and printed successfully!`),w({item_id:"",grade_id:"",weight_id:"",quantity:1,weight_value:0}),B(null),f==null||f()}catch(m){console.error("Error in batch processing:",m),(c=(l=m.response)==null?void 0:l.data)!=null&&c.message?o.error(m.response.data.message):o.error("Failed to process batches. Please try again later."),N({current:0,total:0,isProcessing:!1,isPrinting:!1,currentBatch:[]})}},ae=async t=>{var i,s,u,l;if(t.preventDefault(),!a.item_id||!a.grade_id||!a.weight_id||!a.quantity){o.error("Please fill in all required fields");return}if(a.quantity<1||a.quantity>100){o.error("Quantity must be between 1 and 100");return}if(h&&a.weight_value<=0){o.error("Please enter a valid total weight value (greater than 0)");return}if(g&&!g.is_sufficient){o.error(`Insufficient stock. Available: ${g.available_weight}kg, Required: ${g.required_weight}kg`);return}if(C(!0),a.quantity<=10)try{let c={...a};h&&(c.weight=a.weight_value);const j=(await S.post("/graded-bags-pools",c,{headers:{"X-CSRF-TOKEN":((i=document.querySelector('meta[name="csrf-token"]'))==null?void 0:i.getAttribute("content"))||"","Content-Type":"application/json",Accept:"application/json"}})).data.graded_bags_pools||[];if(o.success(`${a.quantity} graded bags created successfully!`),j.length>0&&r){const n=x.find(b=>b.id.toString()===a.weight_id),v=T.find(b=>b.id.toString()===a.grade_id);try{await X({bags:j,partyName:"Graded Items",weightValue:(n==null?void 0:n.weight)||"Unknown",itemName:(r==null?void 0:r.name)||"Unknown",itemSection:(s=r==null?void 0:r.section)==null?void 0:s.name,gradeName:(v==null?void 0:v.name)||"Unknown",weightType:I,pairCount:h?parseInt(n==null?void 0:n.weight):void 0}),o.success("Labels printed successfully!")}catch(b){console.error("Print error:",b),o.error("Graded bags created but printing failed. You can print them later.")}}w({item_id:"",grade_id:"",weight_id:"",quantity:1,weight_value:0}),B(null),f==null||f()}catch(c){console.error("Error creating graded bags:",c),(l=(u=c.response)==null?void 0:u.data)!=null&&l.message?o.error(c.response.data.message):o.error("Failed to create graded bags. Please try again later.")}else await te();C(!1)},G=d.isProcessing||d.isPrinting,re=d.total>0?d.current/d.total*100:0,ie=()=>h?e.jsxs("div",{className:"grid gap-2",children:[e.jsx(k,{htmlFor:"weight_value",children:"Total Weight (kg) *"}),e.jsx(L,{id:"weight_value",type:"number",step:"0.01",min:"0.01",value:a.weight_value,onChange:t=>F("weight_value",parseFloat(t.target.value)||0),placeholder:"Enter total weight for all bags",required:h}),e.jsxs("p",{className:"text-muted-foreground text-sm",children:["Enter the total weight in kg for all ",a.quantity," bags"]})]}):null,se=()=>{if(!g)return null;const t=g.is_sufficient;return e.jsx("div",{className:`rounded-lg border p-3 ${t?"border-green-200 bg-green-50":"border-red-200 bg-red-50"}`,children:e.jsxs("div",{className:`text-sm ${t?"text-green-900":"text-red-900"}`,children:[e.jsx("div",{className:"mb-1 font-medium",children:"Stock Availability:"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{children:["Available: ",e.jsxs("span",{className:"font-bold",children:[g.available_weight," kg"]})]}),h&&g.available_pair!==void 0&&e.jsxs("div",{children:["Available Pairs: ",e.jsxs("span",{className:"font-bold",children:[g.available_pair," pairs"]})]}),e.jsxs("div",{children:["Required: ",e.jsxs("span",{className:"font-bold",children:[g.required_weight," kg"]})]}),h&&a.pair>0&&e.jsxs("div",{children:["Required Pairs: ",e.jsxs("span",{className:"font-bold",children:[a.pair*a.quantity," pairs"]})]}),!t&&e.jsxs("div",{className:"text-red-700",children:["Shortage: ",e.jsxs("span",{className:"font-bold",children:[g.shortage," kg"]})]})]}),t?e.jsx("div",{className:"mt-2 font-medium text-green-700",children:"✓ Sufficient stock available"}):e.jsx("div",{className:"mt-2 font-medium text-red-700",children:"✗ Insufficient stock"})]})})};return e.jsx(ge,{open:y,onOpenChange:P,children:e.jsxs(he,{className:"max-w-md",children:[e.jsxs(ue,{children:[e.jsx(pe,{children:"Create Graded Bag Pool"}),e.jsx(me,{children:"Create new graded bags. Press Ctrl+O to open this dialog."})]}),e.jsxs("form",{onSubmit:ae,className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(k,{htmlFor:"item",children:"Item *"}),e.jsx(ne,{route:"/api/items/select",value:r,onChange:Z,placeholder:"Select item",renderOption:t=>{var i,s,u,l,c;return console.log(t),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{children:[t.id," - ",t.name]}),e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Y,{variant:"outline",children:((i=t.grade)==null?void 0:i.name)+" Grade"||"No Grade"}),e.jsx(Y,{variant:(s=t.default_weight)!=null&&s.weight?"default":"secondary",children:(u=t.default_weight)!=null&&u.weight?`${t.default_weight.weight} ${(c=(l=t.section)==null?void 0:l.weight_type)==null?void 0:c.toUpperCase()}`:"No Default Weight"})]})]})},renderSelected:t=>t.name}),((R=r==null?void 0:r.section)==null?void 0:R.weight_type)&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-blue-600",children:[e.jsx(we,{className:"h-4 w-4"}),e.jsxs("span",{children:["Section weight type: ",r.section.weight_type.toUpperCase()]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(k,{htmlFor:"grade",children:"Grade *"}),e.jsxs(M,{value:a.grade_id,onValueChange:t=>F("grade_id",t),required:!0,children:[e.jsx(O,{children:e.jsx(z,{placeholder:"Select grade"})}),e.jsx(Q,{children:T.map(t=>e.jsx(K,{value:t.id.toString(),children:t.name},t.id))})]}),a.grade_id&&(r==null?void 0:r.grade_id)===parseInt(a.grade_id)&&e.jsx("div",{className:"text-muted-foreground text-xs",children:"Default grade for this item"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(k,{htmlFor:"weight",children:"Weight Type *"}),e.jsxs(M,{value:a.weight_id,onValueChange:t=>F("weight_id",t),required:!0,disabled:x.length===0,children:[e.jsx(O,{children:e.jsx(z,{placeholder:x.length===0?"Select an item first":"Select weight"})}),e.jsx(Q,{children:x.map(t=>e.jsxs(K,{value:t.id.toString(),children:[t.weight," ",t.weight_type==="kg"?"kg":"pairs"]},t.id))})]}),a.weight_id&&(r==null?void 0:r.default_weight_id)===parseInt(a.weight_id)&&e.jsx("div",{className:"text-muted-foreground text-xs",children:"Default weight for this item"}),a.weight_id&&e.jsx("div",{className:"flex items-center gap-2 text-xs",children:e.jsxs("span",{className:"rounded-full bg-blue-100 px-2 py-0.5 text-blue-800",children:["Type: ",I.toUpperCase()]})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(k,{htmlFor:"quantity",children:"Quantity *"}),e.jsx(L,{id:"quantity",type:"number",min:"1",max:"100",value:a.quantity,onChange:t=>F("quantity",parseInt(t.target.value)||1),placeholder:"Enter quantity (1-100)",required:!0}),a.weight_id&&!h&&e.jsx("div",{className:"text-muted-foreground text-sm",children:(()=>{const t=x.find(s=>s.id.toString()===a.weight_id);return`Total weight required: ${a.quantity*parseFloat((t==null?void 0:t.weight)||"0")}kg`})()}),a.quantity>10&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-amber-600",children:[e.jsx(fe,{className:"h-4 w-4"}),e.jsx("span",{children:"Quantities over 10 will be processed in batches of 10 with automatic printing."})]})]}),ie(),se(),G&&e.jsxs("div",{className:"rounded-lg border bg-blue-50 p-4",children:[e.jsxs("div",{className:"mb-2 flex items-center gap-2",children:[e.jsx(H,{className:"h-4 w-4 text-blue-600"}),e.jsxs("span",{className:"font-medium text-blue-900",children:[d.isPrinting?"Printing Batch":"Creating Batch"," ",d.current," of ",d.total]})]}),e.jsx(xe,{value:re,className:"mb-2"}),e.jsx("div",{className:"text-sm text-blue-700",children:d.isPrinting?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-pulse",children:"🖨️"}),e.jsxs("span",{children:["Printing ",d.currentBatch.length," graded barcodes... Please ensure printer is ready."]})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin",children:"⏳"}),e.jsx("span",{children:"Creating graded bags..."})]})}),d.currentBatch.length>0&&e.jsxs("div",{className:"mt-3 rounded border bg-white p-2",children:[e.jsx("div",{className:"mb-1 text-xs text-gray-600",children:"Current Batch Barcodes:"}),e.jsxs("div",{className:"flex flex-wrap gap-1",children:[d.currentBatch.slice(0,5).map(t=>e.jsx("span",{className:"rounded bg-gray-100 px-1 font-mono text-xs",children:t.barcode},t.id)),d.currentBatch.length>5&&e.jsxs("span",{className:"text-xs text-gray-500",children:["+",d.currentBatch.length-5," more"]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(W,{variant:"outline",type:"button",onClick:P,children:"Cancel"}),e.jsx(W,{type:"submit",disabled:q||G||g&&!g.is_sufficient,className:"gap-2",children:G?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin",children:"⏳"}),"Processing..."]}):q?"Creating...":e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"h-4 w-4"}),"Create & Print Labels"]})})]})]})]})})}const De=Object.freeze(Object.defineProperty({__proto__:null,default:_e},Symbol.toStringTag,{value:"Module"}));export{Y as B,_e as C,De as a};
