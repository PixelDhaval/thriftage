import{r as u,j as t,m as J,a as A}from"./app-C64F3G_T.js";import{b as Z,a as D,B as ee,t as v}from"./index-CySLp5wU.js";import{f as te}from"./dialog-a7AtrYBx.js";import{I as re}from"./input-DJekPU6J.js";import{L as F}from"./label-De44q3qd.js";import{S as se,a as ae,b as ne,c as ie,d as oe}from"./select-b4P1m880.js";import{A as ce}from"./async-select-BuXjVpdO.js";import{P as V,p as k}from"./printBarcodes-DdP7W_zH.js";import{C as le}from"./circle-alert-Bo5Z53SR.js";import"./index-CcLGbvaC.js";import"./floating-ui.react-dom-CxuGM8kq.js";import"./floating-ui.dom-C5vApqfE.js";import"./check-CGM5UAbD.js";function de(e,r=[]){let l=[];function c(p,a){const i=u.createContext(a),s=l.length;l=[...l,a];const m=j=>{var C;const{scope:h,children:_,...x}=j,N=((C=h==null?void 0:h[e])==null?void 0:C[s])||i,$=u.useMemo(()=>x,Object.values(x));return t.jsx(N.Provider,{value:$,children:_})};m.displayName=p+"Provider";function b(j,h){var N;const _=((N=h==null?void 0:h[e])==null?void 0:N[s])||i,x=u.useContext(_);if(x)return x;if(a!==void 0)return a;throw new Error(`\`${j}\` must be used within \`${p}\``)}return[m,b]}const o=()=>{const p=l.map(a=>u.createContext(a));return function(i){const s=(i==null?void 0:i[e])||p;return u.useMemo(()=>({[`__scope${e}`]:{...i,[e]:s}}),[i,s])}};return o.scopeName=e,[c,ue(o,...r)]}function ue(...e){const r=e[0];if(e.length===1)return r;const l=()=>{const c=e.map(o=>({useScope:o(),scopeName:o.scopeName}));return function(p){const a=c.reduce((i,{useScope:s,scopeName:m})=>{const j=s(p)[`__scope${m}`];return{...i,...j}},{});return u.useMemo(()=>({[`__scope${r.scopeName}`]:a}),[a])}};return l.scopeName=r.scopeName,l}var pe=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","select","span","svg","ul"],X=pe.reduce((e,r)=>{const l=Z(`Primitive.${r}`),c=u.forwardRef((o,p)=>{const{asChild:a,...i}=o,s=a?l:r;return typeof window<"u"&&(window[Symbol.for("radix-ui")]=!0),t.jsx(s,{...i,ref:p})});return c.displayName=`Primitive.${r}`,{...e,[r]:c}},{}),M="Progress",R=100,[me,Ae]=de(M),[ge,he]=me(M),Q=u.forwardRef((e,r)=>{const{__scopeProgress:l,value:c=null,max:o,getValueLabel:p=xe,...a}=e;(o||o===0)&&!L(o)&&console.error(fe(`${o}`,"Progress"));const i=L(o)?o:R;c!==null&&!T(c,i)&&console.error(ve(`${c}`,"Progress"));const s=T(c,i)?c:null,m=E(s)?p(s,i):void 0;return t.jsx(ge,{scope:l,value:s,max:i,children:t.jsx(X.div,{"aria-valuemax":i,"aria-valuemin":0,"aria-valuenow":E(s)?s:void 0,"aria-valuetext":m,role:"progressbar","data-state":G(s,i),"data-value":s??void 0,"data-max":i,...a,ref:r})})});Q.displayName=M;var U="ProgressIndicator",z=u.forwardRef((e,r)=>{const{__scopeProgress:l,...c}=e,o=he(U,l);return t.jsx(X.div,{"data-state":G(o.value,o.max),"data-value":o.value??void 0,"data-max":o.max,...c,ref:r})});z.displayName=U;function xe(e,r){return`${Math.round(e/r*100)}%`}function G(e,r){return e==null?"indeterminate":e===r?"complete":"loading"}function E(e){return typeof e=="number"}function L(e){return E(e)&&!isNaN(e)&&e>0}function T(e,r){return E(e)&&!isNaN(e)&&e<=r&&e>=0}function fe(e,r){return`Invalid prop \`max\` of value \`${e}\` supplied to \`${r}\`. Only numbers greater than 0 are valid max values. Defaulting to \`${R}\`.`}function ve(e,r){return`Invalid prop \`value\` of value \`${e}\` supplied to \`${r}\`. The \`value\` prop must be:
  - a positive number
  - less than the value passed to \`max\` (or ${R} if no \`max\` prop is set)
  - \`null\` or \`undefined\` if the progress is indeterminate.

Defaulting to \`null\`.`}var K=Q,be=z;const W=u.forwardRef(({className:e,value:r,...l},c)=>t.jsx(K,{ref:c,className:D("relative h-2 w-full overflow-hidden rounded-full bg-primary/20",e),...l,children:t.jsx(be,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(r||0)}%)`}})}));W.displayName=K.displayName;function Fe({importData:e,onSuccess:r}){const[l,c]=u.useState(!1),[o,p]=u.useState([]),[a,i]=u.useState({current:0,total:0,isProcessing:!1,isPrinting:!1,currentBatch:[]}),{data:s,setData:m,errors:b,setError:j,reset:h,clearErrors:_}=J({import_id:e.id,party_id:"",weight_id:"",quantity:1}),[x,N]=u.useState(null);u.useEffect(()=>{(async()=>{try{const g=await A.get("/api/weights");p(g.data)}catch(g){console.error("Error fetching weights:",g),v.error("Failed to load weights.")}})(),e&&e.type==="local"&&(N(e.party),m("party_id",e.party.id))},[e]);const $=async n=>{var y;return(await A.post("/import-bags/batch",n,{headers:{"X-CSRF-TOKEN":((y=document.querySelector('meta[name="csrf-token"]'))==null?void 0:y.getAttribute("content"))||"","Content-Type":"application/json",Accept:"application/json"}})).data},C=async()=>{var w;const n=s.quantity,g=10,y=Math.ceil(n/g);i({current:0,total:y,isProcessing:!0,isPrinting:!1,currentBatch:[]});try{for(let d=0;d<y;d++){const P=Math.min(g,n-d*g);i(S=>({...S,current:d+1,isProcessing:!0,isPrinting:!1}));const f={import_id:s.import_id,party_id:s.party_id,weight_id:s.weight_id,quantity:P},O=(await $(f)).import_bags;i(S=>({...S,currentBatch:O,isProcessing:!1,isPrinting:!0}));const I=o.find(S=>S.id.toString()===s.weight_id);await k({bags:O,partyName:x.name,containerNo:e==null?void 0:e.container_no,movementDate:e==null?void 0:e.movement_date,weightValue:(I==null?void 0:I.weight)||"Unknown"}),v.success(`Batch ${d+1}/${y} completed: ${P} bags created and printed.`)}i({current:0,total:0,isProcessing:!1,isPrinting:!1,currentBatch:[]}),v.success(`All ${n} bags created and printed successfully!`),h(),r==null||r()}catch(d){if(console.error("Error in batch processing:",d),((w=d.response)==null?void 0:w.status)===422){const P=d.response.data.errors;Object.keys(P).forEach(f=>{j(f,P[f][0])}),v.error("Please check the form for errors.")}else v.error("Failed to process batches. Please try again later.");i({current:0,total:0,isProcessing:!1,isPrinting:!1,currentBatch:[]})}},H=async n=>{var g,y;if(n.preventDefault(),_(),c(!0),s.quantity<=10)try{const d=(await A.post("/import-bags",s,{headers:{"X-CSRF-TOKEN":((g=document.querySelector('meta[name="csrf-token"]'))==null?void 0:g.getAttribute("content"))||"","Content-Type":"application/json",Accept:"application/json"}})).data.import_bags||[],P=d.map(f=>f.barcode);if(v.success(`${s.quantity} bags created successfully!`),d.length>0&&x){const f=o.find(B=>B.id.toString()===s.weight_id);try{await k({bags:d,partyName:x.name,containerNo:e==null?void 0:e.container_no,movementDate:e==null?void 0:e.movement_date,weightValue:(f==null?void 0:f.weight)||"Unknown"}),v.success("Labels printed successfully!")}catch(B){console.error("Print error:",B),v.error("Bags created but printing failed. You can print them later.")}}h(),r==null||r()}catch(w){if(console.error("Error creating import bags:",w),((y=w.response)==null?void 0:y.status)===422){const d=w.response.data.errors;Object.keys(d).forEach(P=>{j(P,d[P][0])}),v.error("Please check the form for errors.")}else v.error("Failed to create import bags. Please try again later.")}else await C();c(!1)},q=a.isProcessing||a.isPrinting,Y=a.total>0?a.current/a.total*100:0;return t.jsxs("form",{onSubmit:H,className:"space-y-6",children:[t.jsxs("div",{className:"grid gap-4",children:[e.type==="container"&&t.jsxs("div",{className:"grid gap-2",children:[t.jsx(F,{htmlFor:"party_id",children:"Supplier"}),t.jsx(ce,{route:"/api/parties/select",params:{type:"supplier"},value:x,onChange:n=>{N(n),m("party_id",(n==null?void 0:n.id)||"")},placeholder:"Select a supplier",renderOption:n=>n.name,renderSelected:n=>n.name}),b.party_id&&t.jsx("p",{className:"text-destructive text-sm",children:b.party_id})]}),t.jsxs("div",{className:"grid gap-2",children:[t.jsx(F,{htmlFor:"weight_id",children:"Weight"}),t.jsxs(se,{value:s.weight_id.toString(),onValueChange:n=>m("weight_id",n),children:[t.jsx(ae,{children:t.jsx(ne,{placeholder:"Select weight"})}),t.jsx(ie,{children:o.map(n=>t.jsxs(oe,{value:n.id.toString(),children:[n.weight," kg"]},n.id))})]}),b.weight_id&&t.jsx("p",{className:"text-destructive text-sm",children:b.weight_id})]}),t.jsxs("div",{className:"grid gap-2",children:[t.jsx(F,{htmlFor:"quantity",children:"Quantity"}),t.jsx(re,{id:"quantity",type:"number",min:"1",value:s.quantity,onChange:n=>m("quantity",parseInt(n.target.value)||1),placeholder:"Enter quantity",required:!0}),b.quantity&&t.jsx("p",{className:"text-destructive text-sm",children:b.quantity}),s.quantity>10&&t.jsxs("div",{className:"flex items-center gap-2 text-sm text-amber-600",children:[t.jsx(le,{className:"h-4 w-4"}),t.jsx("span",{children:"Quantities over 10 will be processed in batches of 10 with automatic printing."})]})]}),q&&t.jsxs("div",{className:"border rounded-lg p-4 bg-blue-50",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[t.jsx(V,{className:"h-4 w-4 text-blue-600"}),t.jsxs("span",{className:"font-medium text-blue-900",children:[a.isPrinting?"Printing Batch":"Creating Batch"," ",a.current," of ",a.total]})]}),t.jsx(W,{value:Y,className:"mb-2"}),t.jsx("div",{className:"text-sm text-blue-700",children:a.isPrinting?t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"animate-pulse",children:"🖨️"}),t.jsxs("span",{children:["Printing ",a.currentBatch.length," barcodes... Please ensure printer is ready."]})]}):t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"animate-spin",children:"⏳"}),t.jsx("span",{children:"Creating import bags..."})]})}),a.currentBatch.length>0&&t.jsxs("div",{className:"mt-3 p-2 bg-white rounded border",children:[t.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Current Batch Barcodes:"}),t.jsxs("div",{className:"flex flex-wrap gap-1",children:[a.currentBatch.slice(0,5).map(n=>t.jsx("span",{className:"text-xs font-mono bg-gray-100 px-1 rounded",children:n.barcode},n.id)),a.currentBatch.length>5&&t.jsxs("span",{className:"text-xs text-gray-500",children:["+",a.currentBatch.length-5," more"]})]})]})]})]}),t.jsx(te,{children:t.jsx(ee,{type:"submit",disabled:l||q,className:"gap-2",children:q?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"animate-spin",children:"⏳"}),"Processing..."]}):l?"Creating...":t.jsxs(t.Fragment,{children:[t.jsx(V,{className:"h-4 w-4"}),"Create & Print Labels"]})})})]})}export{Fe as default};
